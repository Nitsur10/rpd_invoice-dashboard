[{"createdAt":"2025-08-23T11:44:10.208Z","updatedAt":"2025-08-23T11:58:02.000Z","id":"3wJiUPpYLEz7lGuu","name":"Twilio ZARA AI Agent - Full System","active":false,"isArchived":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"twilio/wa","responseMode":"responseNode","options":{"rawBody":false}},"type":"n8n-nodes-base.webhook","typeVersion":2.1,"position":[112,148],"id":"webhook-node","name":"When chat message received","webhookId":"bc8c3e4a-bdd8-4d62-8967-fa787e57bf0c"},{"parameters":{"jsCode":"// SIMPLIFIED WEBHOOK PROCESSING (n8n compatible)\ntry {\n  const body = $json.body || {};\n  const signature = $json.headers?.['x-twilio-signature'] || '';\n  \n  console.log('🔐 Processing Twilio webhook...');\n  console.log('📋 Body keys:', Object.keys(body));\n  console.log('🔑 Signature present:', !!signature);\n  \n  // Skip crypto verification for now - can be added later via HTTP node\n  console.log('✅ Webhook processing completed');\n  \n  return [{ json: body }];\n  \n} catch (error) {\n  console.error('❌ Webhook processing error:', error.message);\n  return [{ json: $json.body || $json }];\n}"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[336,148],"id":"process-webhook","name":"Process Webhook"},{"parameters":{"jsCode":"// PARSE INCOMING WHATSAPP MESSAGE FOR AI SYSTEM\nconst data = $json || {};\n\nconsole.log('📨 Processing WhatsApp message for ZARA AI:', JSON.stringify(data, null, 2));\n\n// Extract WhatsApp data and format for AI agents\nconst parsed = {\n  // Core message data\n  from: data.From || '',\n  to: data.To || '',\n  body: data.Body || '',\n  \n  // WhatsApp specific\n  wa_id: data.WaId || '',\n  message_sid: data.MessageSid || '',\n  profile_name: data.ProfileName || '',\n  \n  // Media handling\n  num_media: parseInt(data.NumMedia || '0'),\n  media_urls: [],\n  \n  // Format for AI agents\n  chat_input: data.Body || '',\n  user_id: data.From || data.WaId || '',\n  session_id: `wa_${data.WaId || data.From}`,\n  \n  // Metadata for Supabase\n  timestamp: new Date().toISOString(),\n  direction: 'inbound',\n  status: 'received',\n  channel: 'whatsapp',\n  \n  // Raw data for debugging\n  raw_webhook: data\n};\n\n// Extract media URLs if present\nif (parsed.num_media > 0) {\n  for (let i = 0; i < parsed.num_media; i++) {\n    const mediaUrl = data[`MediaUrl${i}`];\n    if (mediaUrl) parsed.media_urls.push(mediaUrl);\n  }\n}\n\nconsole.log('✅ Parsed for ZARA AI System:', {\n  from: parsed.from,\n  body: parsed.body,\n  chat_input: parsed.chat_input,\n  session_id: parsed.session_id,\n  wa_id: parsed.wa_id\n});\n\nreturn [{ json: parsed }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[560,148],"id":"parse-message","name":"Parse Message for AI"},{"parameters":{"operation":"insert"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[904,0],"id":"store-message","name":"Store in Supabase","credentials":{"supabaseApi":{"id":"your-supabase-credential-id","name":"Supabase account"}}},{"parameters":{"jsCode":"// PROCESS MEMORY PICKER OUTPUT AND PREPARE FOR KNOW IT ALL\nconst memoryResult = $json;\nconst originalData = $input.first().json;\n\nconsole.log('🧠 Processing Memory Picker Result...');\n\n// Extract AI response and tool calls\nlet analysis = {};\nlet toolCalls = [];\nlet toolResults = [];\n\ntry {\n  if (memoryResult.choices && memoryResult.choices[0]) {\n    const choice = memoryResult.choices[0];\n    \n    // Get the message content (analysis)\n    if (choice.message && choice.message.content) {\n      try {\n        // Try to parse as JSON first\n        analysis = JSON.parse(choice.message.content);\n      } catch (e) {\n        // If not JSON, treat as text analysis\n        analysis = {\n          memory_action: 'store',\n          entity_type: 'general',\n          extracted_data: { content: choice.message.content },\n          confidence: 0.7,\n          next_step: 'generate_contextual_response'\n        };\n      }\n    }\n    \n    // Get tool calls if any were made\n    if (choice.message && choice.message.tool_calls) {\n      toolCalls = choice.message.tool_calls;\n      console.log('🔧 Tool calls made:', toolCalls.length);\n    }\n  }\n} catch (error) {\n  console.error('❌ Error processing Memory Picker result:', error.message);\n  analysis = { \n    error: error.message, \n    memory_action: 'none',\n    entity_type: 'general',\n    extracted_data: {},\n    confidence: 0.1,\n    next_step: 'generate_basic_response'\n  };\n}\n\n// Enhance original data with memory analysis\nconst enhanced = {\n  ...originalData,\n  memory_analysis: analysis,\n  tool_calls: toolCalls,\n  tool_results: toolResults,\n  memory_processed_at: new Date().toISOString(),\n  ai_tokens_used: memoryResult.usage?.total_tokens || 0\n};\n\nconsole.log('✅ Enhanced data for Know it all:', {\n  memory_action: analysis.memory_action,\n  entity_type: analysis.entity_type,\n  tool_calls_count: toolCalls.length,\n  confidence: analysis.confidence\n});\n\nreturn [{ json: enhanced }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1248,296],"id":"process-memory","name":"Process Memory Result"},{"parameters":{"jsCode":"// EXTRACT AND PREPARE FINAL ZARA RESPONSE\nconst knowItAllResult = $json;\nconst originalData = $input.first().json;\n\nconsole.log('🤖 Processing Know it all response...');\n\nlet finalResponse = \"Thanks for your message! I'm ZARA, your RPD assistant. I'm here to help you with your property development needs.\";\nlet tokensUsed = 0;\n\ntry {\n  if (knowItAllResult.choices && knowItAllResult.choices[0]) {\n    const choice = knowItAllResult.choices[0];\n    \n    if (choice.message && choice.message.content) {\n      finalResponse = choice.message.content.trim();\n    }\n    \n    tokensUsed = knowItAllResult.usage?.total_tokens || 0;\n  }\n} catch (error) {\n  console.error('❌ Error extracting Know it all response:', error.message);\n  finalResponse = \"I encountered an issue processing your message. Could you please try again? I'm here to help with your RPD needs!\";\n}\n\n// Ensure response is not too long for WhatsApp\nif (finalResponse.length > 1500) {\n  finalResponse = finalResponse.substring(0, 1450) + '...';\n}\n\n// Prepare final response data\nconst responseData = {\n  ...originalData,\n  ai_response: finalResponse,\n  response_type: 'zara_ai_agent',\n  generated_at: new Date().toISOString(),\n  total_tokens_used: (originalData.ai_tokens_used || 0) + tokensUsed,\n  memory_confidence: originalData.memory_analysis?.confidence || 0.5\n};\n\nconsole.log('✅ Final ZARA AI Response prepared:', {\n  response_length: finalResponse.length,\n  session_id: responseData.session_id,\n  total_tokens: responseData.total_tokens_used,\n  confidence: responseData.memory_confidence\n});\n\nreturn [{ json: responseData }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1824,296],"id":"extract-response","name":"Extract ZARA Response"},{"parameters":{"from":"+14155238886","to":"={{ $json.from.replace('whatsapp:', '') }}","toWhatsapp":true,"message":"={{ $json.ai_response }}","options":{"statusCallback":"https://13-54-176-108.nip.io/webhook/twilio/status"}},"type":"n8n-nodes-base.twilio","typeVersion":1,"position":[2048,296],"id":"send-whatsapp","name":"Send WhatsApp Response","credentials":{"twilioApi":{"id":"Wm9Sit5boLY4pUjX","name":"Twilio account"}}},{"parameters":{"operation":"insert"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2272,128],"id":"store-response","name":"Store Response","credentials":{"supabaseApi":{"id":"your-supabase-credential-id","name":"Supabase account"}}},{"parameters":{"operation":"upsert"},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[112,624],"id":"update-client","name":"Update Client Context","credentials":{"supabaseApi":{"id":"your-supabase-credential-id","name":"Supabase account"}}},{"parameters":{"options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[2496,296],"id":"respond-webhook","name":"Respond to Webhook"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[840,296],"id":"8ea603ba-f8f9-41d0-b67f-fbb5a7748f5c","name":"AI Agent"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":2.2,"position":[1472,296],"id":"2ab43f82-06d9-4355-a6ed-fc8a7677266e","name":"AI Agent1"},{"parameters":{},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[784,520],"id":"97a0f825-d9ed-4f78-ae1f-c2ba71e81b17","name":"Create a row in Supabase"},{"parameters":{"operation":"update"},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[912,520],"id":"9533c9e3-4a7b-44c7-823d-56ba035be358","name":"Update a row in Supabase"},{"parameters":{},"type":"n8n-nodes-base.supabaseTool","typeVersion":1,"position":[1040,520],"id":"e414087d-1032-4942-a8f9-b19d7050f894","name":"Create a row in Supabase1"}],"connections":{"When chat message received":{"main":[[{"node":"Process Webhook","type":"main","index":0}]]},"Process Webhook":{"main":[[{"node":"Parse Message for AI","type":"main","index":0}]]},"Parse Message for AI":{"main":[[{"node":"Store in Supabase","type":"main","index":0},{"node":"AI Agent","type":"main","index":0}]]},"Process Memory Result":{"main":[[{"node":"AI Agent1","type":"main","index":0}]]},"Extract ZARA Response":{"main":[[{"node":"Send WhatsApp Response","type":"main","index":0}]]},"Send WhatsApp Response":{"main":[[{"node":"Store Response","type":"main","index":0},{"node":"Respond to Webhook","type":"main","index":0}]]},"Store Response":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"Update Client Context":{"main":[[]]},"AI Agent":{"main":[[{"node":"Process Memory Result","type":"main","index":0}]]},"AI Agent1":{"main":[[{"node":"Extract ZARA Response","type":"main","index":0}]]},"Create a row in Supabase":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Update a row in Supabase":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"Create a row in Supabase1":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"7b2fa68a-6903-4e58-8fbd-1ab2a53ad2a4","triggerCount":0,"tags":[],"shared":[{"createdAt":"2025-08-23T11:44:10.214Z","updatedAt":"2025-08-23T11:44:10.214Z","role":"workflow:owner","workflowId":"3wJiUPpYLEz7lGuu","projectId":"OOfqf1PcdXc4mAMQ","project":{"createdAt":"2025-08-02T11:30:32.205Z","updatedAt":"2025-08-02T11:32:05.229Z","id":"OOfqf1PcdXc4mAMQ","name":"SSS Sure <sureshotsolutions09@gmail.com>","type":"personal","icon":null,"description":null}}]}]