<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code - Unified Agent Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 30%, #16213e 60%, #0f1419 100%);
            color: #ffffff;
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .container {
            width: 100vw;
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header with Tabs - Compact */
        .header {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 8px;
            background: linear-gradient(135deg, oklch(0.81 0.10 252), oklch(0.62 0.19 260), oklch(0.55 0.22 263), oklch(0.49 0.22 264));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(99, 102, 241, 0.4);
            filter: drop-shadow(0 0 8px rgba(16, 185, 129, 0.25));
        }

        .header p {
            opacity: 0.9;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tab-button {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            backdrop-filter: blur(10px);
            font-size: 0.85rem;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6, #10b981);
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .tab-button:hover:not(.active) {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        /* Tab Content - Flexible */
        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Summary Panel - Compact */
        .summary-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px 20px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .summary-item.active-highlight {
            background: linear-gradient(135deg, 
                rgba(99, 102, 241, 0.12) 0%, 
                rgba(16, 185, 129, 0.08) 100%);
            border: 1px solid oklch(0.81 0.10 252 / 0.3);
            box-shadow: 
                0 0 20px rgba(99, 102, 241, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            background: linear-gradient(135deg, oklch(0.81 0.10 252), oklch(0.62 0.19 260), oklch(0.55 0.22 263));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 6px rgba(99, 102, 241, 0.3));
        }
        
        .summary-value.active-highlight {
            font-size: 2.8rem;
            background: linear-gradient(135deg, oklch(0.81 0.10 252), oklch(0.62 0.19 260));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 15px rgba(99, 102, 241, 0.6));
            animation: activeGlow 2s ease-in-out infinite alternate;
        }
        
        @keyframes activeGlow {
            from { 
                filter: drop-shadow(0 0 15px rgba(99, 102, 241, 0.6));
                transform: scale(1);
            }
            to { 
                filter: drop-shadow(0 0 25px rgba(16, 185, 129, 0.8));
                transform: scale(1.05);
            }
        }

        .summary-label {
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Individual Agents Grid - Simplified with Clear Spacing */
        .agents-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            gap: 40px;
            box-sizing: border-box;
        }
        
        /* Responsive spacing adjustments */
        @media (max-width: 799px) {
            .agents-grid {
                padding: 20px;
                gap: 30px;
            }
            
            .agent-card {
                width: calc(100% - 40px);
                margin: 20px;
            }
        }

        .agent-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 2px solid rgba(255, 255, 255, 0.15);
            padding: 20px;
            margin: 25px;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            height: fit-content;
            display: flex;
            flex-direction: column;
            gap: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1;
            width: 350px;
            flex-shrink: 0;
        }
        
        .agent-card.active-agent {
            background: linear-gradient(135deg, 
                rgba(99, 102, 241, 0.25) 0%, 
                rgba(16, 185, 129, 0.20) 50%, 
                rgba(245, 158, 11, 0.15) 100%);
            border: 2px solid oklch(0.81 0.10 252);
            box-shadow: 
                0 0 40px rgba(99, 102, 241, 0.4),
                0 0 80px rgba(16, 185, 129, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                0 0 0 3px rgba(99, 102, 241, 0.2);
            transform: translateY(-1px) scale(1.005);
        }
        
        .agent-card.active-agent::after {
            content: '';
            position: absolute;
            inset: -3px;
            background: linear-gradient(135deg, 
                oklch(0.81 0.10 252 / 0.3) 0%, 
                oklch(0.62 0.19 260 / 0.25) 50%, 
                oklch(0.81 0.10 252 / 0.3) 100%);
            border-radius: 19px;
            z-index: -1;
            animation: activeCardGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes activeCardGlow {
            from { 
                background: linear-gradient(135deg, 
                    oklch(0.81 0.10 252 / 0.3) 0%, 
                    oklch(0.62 0.19 260 / 0.25) 50%, 
                    oklch(0.81 0.10 252 / 0.3) 100%);
            }
            to { 
                background: linear-gradient(135deg, 
                    oklch(0.62 0.19 260 / 0.4) 0%, 
                    oklch(0.81 0.10 252 / 0.35) 50%, 
                    oklch(0.62 0.19 260 / 0.4) 100%);
            }
        }
        
        .agent-card.coordinating-agent {
            background: linear-gradient(135deg, 
                rgba(16, 185, 129, 0.28) 0%, 
                rgba(99, 102, 241, 0.25) 50%, 
                rgba(245, 158, 11, 0.20) 100%);
            border: 2px solid oklch(0.62 0.19 260);
            box-shadow: 
                0 0 50px rgba(16, 185, 129, 0.5),
                0 0 90px rgba(99, 102, 241, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.45),
                0 0 0 4px rgba(16, 185, 129, 0.25);
            transform: translateY(-1px) scale(1.005);
        }
        
        .agent-card.coordinating-agent::after {
            content: '';
            position: absolute;
            inset: -4px;
            background: linear-gradient(135deg, 
                oklch(0.62 0.19 260 / 0.4) 0%, 
                oklch(0.55 0.22 263 / 0.35) 33%, 
                oklch(0.49 0.22 264 / 0.3) 66%, 
                oklch(0.62 0.19 260 / 0.4) 100%);
            border-radius: 20px;
            z-index: -1;
            animation: coordinatingCardGlow 2s ease-in-out infinite;
        }
        
        @keyframes coordinatingCardGlow {
            0%, 100% { 
                opacity: 0.8;
                transform: scale(1);
            }
            50% { 
                opacity: 1;
                transform: scale(1.005);
            }
        }

        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, oklch(0.81 0.10 252), oklch(0.62 0.19 260), oklch(0.55 0.22 263));
        }
        
        .agent-card.active-agent::before {
            height: 4px;
            background: linear-gradient(90deg, 
                oklch(0.81 0.10 252) 0%, 
                oklch(0.62 0.19 260) 25%, 
                oklch(0.55 0.22 263) 50%, 
                oklch(0.49 0.22 264) 75%, 
                oklch(0.42 0.18 266) 100%);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.5);
        }
        
        .agent-card.coordinating-agent::before {
            height: 5px;
            background: linear-gradient(90deg, 
                oklch(0.62 0.19 260) 0%, 
                oklch(0.55 0.22 263) 33%, 
                oklch(0.49 0.22 264) 66%, 
                oklch(0.42 0.18 266) 100%);
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.6);
            animation: shimmer 2s ease-in-out infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; transform: scaleY(1.2); }
        }

        .agent-card:hover {
            transform: translateY(-2px) scale(1.005);
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                0 0 30px oklch(0.81 0.10 252 / 0.3);
            border-color: oklch(0.81 0.10 252);
        }
        
        .agent-card.active-agent:hover {
            transform: translateY(-2px) scale(1.005);
            box-shadow: 
                0 30px 60px rgba(0, 0, 0, 0.6),
                0 0 50px rgba(99, 102, 241, 0.5),
                0 0 80px rgba(16, 185, 129, 0.3);
        }
        
        .agent-card.coordinating-agent:hover {
            transform: translateY(-2px) scale(1.005);
            box-shadow: 
                0 35px 70px rgba(0, 0, 0, 0.7),
                0 0 60px rgba(16, 185, 129, 0.6),
                0 0 100px rgba(99, 102, 241, 0.4);
        }

        .agent-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-size: 1.15rem;
            font-weight: 600;
            margin-bottom: 4px;
            line-height: 1.2;
        }

        .agent-specialty {
            opacity: 0.7;
            font-size: 0.8rem;
            line-height: 1.3;
        }

        .agent-icon {
            font-size: 1.8rem;
            margin-right: 12px;
        }

        .agent-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 10px 16px;
            border-radius: 25px;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .agent-status.active {
            background: linear-gradient(135deg, oklch(0.81 0.10 252 / 0.25), oklch(0.62 0.19 260 / 0.2));
            border: 1px solid oklch(0.81 0.10 252 / 0.5);
            color: oklch(0.922 0 0);
            text-shadow: 0 0 10px rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
        }
        
        .agent-status.coordinating {
            background: linear-gradient(135deg, oklch(0.62 0.19 260 / 0.3), oklch(0.55 0.22 263 / 0.25));
            border: 1px solid oklch(0.62 0.19 260 / 0.6);
            color: oklch(0.922 0 0);
            text-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 25px rgba(16, 185, 129, 0.4); }
            to { box-shadow: 0 0 35px rgba(16, 185, 129, 0.6), 0 0 50px rgba(99, 102, 241, 0.3); }
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-shadow: 0 0 8px currentColor;
        }
        
        .active .status-dot {
            width: 12px;
            height: 12px;
            background-color: oklch(0.81 0.10 252);
            box-shadow: 
                0 0 15px oklch(0.81 0.10 252),
                0 0 25px oklch(0.81 0.10 252 / 0.6);
        }
        
        .coordinating .status-dot {
            width: 14px;
            height: 14px;
            background-color: oklch(0.62 0.19 260);
            box-shadow: 
                0 0 18px oklch(0.62 0.19 260),
                0 0 30px oklch(0.62 0.19 260 / 0.7);
            animation: coordinatingPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes coordinatingPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 18px oklch(0.62 0.19 260), 0 0 30px oklch(0.62 0.19 260 / 0.7);
            }
            50% { 
                transform: scale(1.3);
                box-shadow: 0 0 25px oklch(0.62 0.19 260), 0 0 45px oklch(0.62 0.19 260 / 0.8);
            }
        }

        .agent-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .metric {
            text-align: center;
            padding: 12px 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-label {
            display: block;
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #10b981;
        }

        .current-work {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            border-left: 3px solid #3b82f6;
        }

        .work-label {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .work-description {
            font-weight: 500;
            line-height: 1.3;
            font-size: 0.9rem;
        }

        .token-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 10px;
            padding: 10px 12px;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .token-amount {
            font-weight: 600;
            font-size: 1rem;
        }

        .token-cost {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .last-activity {
            text-align: center;
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 10px;
        }

        /* Analytics Panel - Viewport Fit */
        .analytics-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            flex: 1;
            min-height: 0;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 16px;
            display: flex;
            flex-direction: column;
            min-height: 0;
            flex: 1;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            flex-shrink: 0;
        }

        /* Token Usage Blocks (ccusage style) */
        .usage-blocks-container {
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
            overflow-y: auto;
            max-height: 100%;
            box-sizing: border-box;
        }

        .usage-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .usage-header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .gradient-text {
            background: linear-gradient(135deg, oklch(0.81 0.10 252), oklch(0.62 0.19 260), oklch(0.55 0.22 263));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .model-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .model-name {
            font-weight: 600;
            color: oklch(0.62 0.19 260);
        }

        .token-count {
            font-weight: 500;
        }

        .usage-blocks {
            margin: 30px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 4px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .token-block {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .token-block:hover {
            transform: scale(1.2);
        }

        .token-block.system-prompt { background: oklch(0.49 0.22 264); }
        .token-block.system-tools { background: oklch(0.55 0.22 263); }
        .token-block.mcp-tools { background: oklch(0.62 0.19 260); }
        .token-block.memory-files { background: oklch(0.72 0.15 257); }
        .token-block.messages { background: oklch(0.81 0.10 252); }
        .token-block.agent-context { background: linear-gradient(45deg, oklch(0.65 0.18 340), oklch(0.75 0.15 320)); animation: agentPulse 3s ease-in-out infinite; }
        .token-block.free-space { background: rgba(255, 255, 255, 0.1); }

        @keyframes agentPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .usage-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breakdown-icon {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .breakdown-text {
            flex: 1;
        }

        .breakdown-label {
            font-size: 0.9rem;
            color: #ffffff;
            font-weight: 500;
        }

        .breakdown-value {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 2px;
        }

        /* Agent Context Section */
        .agent-context-section {
            margin-top: 40px;
            padding-top: 30px;
            padding-bottom: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .agent-context-section h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
            text-align: center;
        }

        .agent-context-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }

        .agent-context-item {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.08) 0%, 
                rgba(255, 255, 255, 0.04) 100%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 8px;
            padding: 12px 14px;
            position: relative;
            overflow: hidden;
        }

        .agent-context-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, oklch(0.65 0.18 340), oklch(0.75 0.15 320));
        }

        .agent-context-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 6px;
        }

        .agent-context-usage {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-context-tokens {
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
        }

        .agent-context-cost {
            color: oklch(0.65 0.18 340);
            font-weight: 500;
        }

        /* Activity Feed - Flexible Height */
        .activity-feed {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .activity-icon {
            font-size: 1.5rem;
            width: 40px;
            text-align: center;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .activity-description {
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .activity-time {
            font-size: 0.8rem;
            opacity: 0.6;
        }

        /* Enhanced Status Colors */
        .ready .status-dot { 
            background-color: oklch(0.55 0.22 263);
            box-shadow: 0 0 12px oklch(0.55 0.22 263), 0 0 20px oklch(0.55 0.22 263 / 0.5);
        }
        .idle .status-dot { 
            background-color: oklch(0.49 0.22 264);
            box-shadow: 0 0 8px oklch(0.49 0.22 264), 0 0 15px oklch(0.49 0.22 264 / 0.4);
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Custom Scrollbar */
        .agents-grid::-webkit-scrollbar,
        .activity-feed::-webkit-scrollbar {
            width: 6px;
        }
        
        .agents-grid::-webkit-scrollbar-track,
        .activity-feed::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        .agents-grid::-webkit-scrollbar-thumb,
        .activity-feed::-webkit-scrollbar-thumb {
            background: oklch(0.81 0.10 252 / 0.6);
            border-radius: 3px;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .analytics-panel {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 10px 15px;
                margin-bottom: 10px;
            }
            
            .summary-panel {
                padding: 10px 15px;
                margin-bottom: 10px;
            }
        }
        
        @media (max-height: 600px) {
            .header h1 {
                font-size: 1.5rem;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.8rem;
                margin-bottom: 10px;
            }
            
            .summary-value {
                font-size: 1.4rem;
            }
        }
        
        /* Task Queue Visualization */
        .task-queue {
            margin-top: 12px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 8px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .queue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .queue-title {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .queue-count {
            background: linear-gradient(135deg, oklch(0.81 0.10 252), oklch(0.62 0.19 260));
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            flex-shrink: 0;
        }
        
        .queue-count.high-priority {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            animation: urgentPulse 2s ease-in-out infinite;
        }
        
        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .task-list {
            max-height: 120px;
            overflow-y: auto;
        }
        
        .task-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            margin-bottom: 4px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .task-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }
        
        .task-item.priority-critical {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }
        
        .task-item.priority-high {
            border-left-color: #ff6348;
            background: rgba(255, 99, 72, 0.08);
        }
        
        .task-item.priority-normal {
            border-left-color: oklch(0.81 0.10 252);
            background: rgba(99, 102, 241, 0.08);
        }
        
        .task-item.priority-low {
            border-left-color: #95a5a6;
            background: rgba(149, 165, 166, 0.06);
        }
        
        .task-name {
            font-size: 0.75rem;
            font-weight: 500;
            flex: 1;
            line-height: 1.2;
        }
        
        .task-meta {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .task-time {
            font-size: 0.7rem;
            opacity: 0.7;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .task-priority {
            font-size: 0.6rem;
            padding: 2px 5px;
            border-radius: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .task-priority.critical {
            background: #ff4757;
            color: white;
            box-shadow: 0 0 8px rgba(255, 71, 87, 0.4);
        }
        
        .task-priority.high {
            background: #ff6348;
            color: white;
        }
        
        .task-priority.normal {
            background: oklch(0.81 0.10 252);
            color: white;
        }
        
        .task-priority.low {
            background: #95a5a6;
            color: white;
        }
        
        /* Queue indicators for active agents */
        .agent-card.active-agent .queue-count,
        .agent-card.coordinating-agent .queue-count {
            animation: queueGlow 3s ease-in-out infinite alternate;
        }
        
        /* Clean separator styling */
        .stat-separator {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Improved hover state for task summary */
        .task-summary:hover .top-task {
            color: oklch(0.81 0.10 252);
        }
        
        @keyframes queueGlow {
            from { box-shadow: 0 0 5px rgba(99, 102, 241, 0.3); }
            to { box-shadow: 0 0 15px rgba(16, 185, 129, 0.6); }
        }
        
        /* Custom scrollbar for task list */
        .task-list::-webkit-scrollbar {
            width: 3px;
        }
        
        .task-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }
        
        .task-list::-webkit-scrollbar-thumb {
            background: oklch(0.81 0.10 252 / 0.6);
            border-radius: 2px;
        }
        
        /* History Panel Styles */
        .history-panel {
            padding: 30px;
            max-height: 100%;
            overflow-y: auto;
        }
        
        .history-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .history-controls h2 {
            margin: 0;
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .time-controls {
            display: flex;
            gap: 8px;
        }
        
        .time-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .time-btn:hover {
            background: linear-gradient(135deg, 
                rgba(99, 102, 241, 0.3) 0%, 
                rgba(16, 185, 129, 0.2) 100%);
            border-color: oklch(0.81 0.10 252 / 0.5);
            transform: translateY(-1px);
        }
        
        .time-btn.active {
            background: linear-gradient(135deg, 
                oklch(0.81 0.10 252) 0%, 
                oklch(0.62 0.19 260) 100%);
            border-color: oklch(0.81 0.10 252);
            color: #000000;
            font-weight: 600;
        }
        
        .history-charts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: oklch(0.81 0.10 252 / 0.5);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: oklch(0.81 0.10 252);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }
        
        @media (max-width: 768px) {
            .history-charts {
                grid-template-columns: 1fr;
            }
            
            .history-controls {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .time-controls {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ¯ Claude Code - Unified Monitor</h1>
            <p>Complete agent monitoring with individual tracking and enterprise analytics</p>
            
            <div class="tabs">
                <button class="tab-button active" data-tab="individual">ðŸ¤– Individual Agents</button>
                <button class="tab-button" data-tab="analytics">ðŸ“Š Analytics Dashboard</button>
                <button class="tab-button" data-tab="usage">ðŸŽ¯ Token Usage Blocks</button>
                <button class="tab-button" data-tab="history">ðŸ“ˆ Usage History</button>
            </div>
        </div>

        <!-- Summary Panel (always visible) -->
        <div class="summary-panel">
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-value" id="totalAgents">8</div>
                    <div class="summary-label">Total Agents</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="activeAgents">--</div>
                    <div class="summary-label">Active Now</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="totalTokens">--</div>
                    <div class="summary-label">Total Tokens</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="totalCost">--</div>
                    <div class="summary-label">Total Cost</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="totalTasks">--</div>
                    <div class="summary-label">Tasks Completed</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="sessionTime">--</div>
                    <div class="summary-label">Session Time</div>
                </div>
            </div>
        </div>

        <!-- Tab: Individual Agents -->
        <div class="tab-content active" id="individual">
            <div class="agents-grid" id="agentsGrid">
                <div style="text-align: center; padding: 40px; opacity: 0.6;">
                    <h3>ðŸ”„ Loading individual agent data...</h3>
                    <p>Connecting to Claude Code session</p>
                </div>
            </div>
        </div>

        <!-- Tab: Analytics Dashboard -->
        <div class="tab-content" id="analytics">
            <div class="analytics-panel">
                <div class="chart-container">
                    <div class="chart-title">ðŸ”¥ Agent Token Consumption (Real-time)</div>
                    <canvas id="agentTokenChart" style="height: 280px;"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">âš¡ Agent Performance Efficiency</div>
                    <canvas id="performanceChart" style="height: 250px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Tab: Token Usage Blocks (ccusage style) -->
        <div class="tab-content" id="usage">
            <div class="usage-blocks-container">
                <div class="usage-header">
                    <h2>ðŸŽ¯ <span class="gradient-text">Context Usage</span></h2>
                    <div class="model-info">
                        <span class="model-name">claude-sonnet-4-20250514</span>
                        <span class="token-count" id="usageTokenCount">100k/200k tokens (50%)</span>
                    </div>
                </div>
                
                <div class="usage-blocks" id="usageBlocks">
                    <!-- Token blocks will be populated here -->
                </div>
                
                <div class="usage-breakdown" id="usageBreakdown">
                    <!-- Detailed breakdown will be populated here -->
                </div>
                
                <div class="agent-context-section">
                    <h3>ðŸ¤– Individual Agent Context Usage</h3>
                    <div class="agent-context-grid" id="agentContextGrid">
                        <!-- Agent context breakdown will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Usage History -->
        <div class="tab-content" id="history">
            <div class="history-panel">
                <div class="history-controls">
                    <h2>ðŸ“ˆ Token Usage History</h2>
                    <div class="time-controls">
                        <button class="time-btn active" data-hours="1">1 Hour</button>
                        <button class="time-btn" data-hours="6">6 Hours</button>
                        <button class="time-btn" data-hours="24">24 Hours</button>
                        <button class="time-btn" data-hours="168">7 Days</button>
                    </div>
                </div>
                
                <div class="history-charts">
                    <div class="chart-container">
                        <div class="chart-title">ðŸ”¥ Token Usage Over Time</div>
                        <canvas id="historyTokenChart" style="height: 300px;"></canvas>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">ðŸ’° Cost Trends</div>
                        <canvas id="historyCostChart" style="height: 250px;"></canvas>
                    </div>
                </div>
                
                <div class="history-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalSessions">--</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgTokensPerSession">--</div>
                        <div class="stat-label">Avg Tokens/Session</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalCostHistory">--</div>
                        <div class="stat-label">Total Cost</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="peakUsage">--</div>
                        <div class="stat-label">Peak Usage</div>
                    </div>
                </div>
                
                <div style="text-align: center; padding: 20px; opacity: 0.6;" id="historyLoading">
                    <h3>ðŸ“ˆ Loading usage history...</h3>
                    <p>Retrieving historical token usage data</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        class UnifiedClaudeMonitor {
            constructor() {
                this.agents = [];
                this.agentTokenChart = null;
                this.performanceChart = null;
                this.activityLog = [];
                this.startTime = Date.now();
                
                this.initializeTabs();
                this.loadData();
                this.startMonitoring();
                this.initializeCharts();
                this.initializeUsageBlocks();
            }

            initializeTabs() {
                const tabButtons = document.querySelectorAll('.tab-button');
                const tabContents = document.querySelectorAll('.tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.dataset.tab;
                        
                        // Update button states
                        tabButtons.forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        
                        // Update content visibility
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                        });
                        document.getElementById(targetTab).classList.add('active');
                        
                        // Refresh charts when analytics tab is opened
                        if (targetTab === 'analytics') {
                            setTimeout(() => this.updateCharts(), 100);
                        }
                    });
                });
            }

            async loadData() {
                try {
                    const response = await fetch('/api/claude-status');
                    const data = await response.json();
                    
                    if (data.agents) {
                        this.agents = data.agents;
                        this.updateIndividualAgents();
                        this.updateSummary();
                        this.updateActivity();
                        this.updateCharts(); // Real-time chart updates
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError();
                }
            }

            updateIndividualAgents() {
                const grid = document.getElementById('agentsGrid');
                if (!grid) return;

                let html = '';
                this.agents.forEach(agent => {
                    const timeSince = Math.floor((Date.now() / 1000) - agent.lastActivity);
                    const tokenCost = (agent.tokensUsed * 0.015 / 1000).toFixed(3);
                    const avgTokensPerTask = Math.round(agent.tokensUsed / Math.max(agent.tasksCompleted, 1));
                    
                    // Apply bright active classes
                    let cardClass = 'agent-card';
                    if (agent.status === 'active') {
                        cardClass += ' active-agent';
                    } else if (agent.status === 'coordinating') {
                        cardClass += ' coordinating-agent';
                    }

                    html += `
                        <div class="${cardClass}">
                            <div class="agent-header">
                                <div class="agent-icon">${this.getAgentIcon(agent.id)}</div>
                                <div class="agent-info">
                                    <div class="agent-name">${agent.name}</div>
                                    <div class="agent-stats">
                                        <span class="stat-item">${agent.efficiency}% efficiency</span>
                                        <div class="stat-separator"></div>
                                        <span class="stat-item">${this.getStatusEmoji(agent.status)} ${this.getStatusDescription(agent.status)}</span>
                                    </div>
                                </div>
                                <div class="agent-status ${agent.status}">
                                    <span class="status-dot"></span>
                                    ${agent.status.toUpperCase()}
                                </div>
                            </div>

                            <div class="current-work">
                                <div class="work-label">Current Task</div>
                                <div class="work-description">${agent.currentTask}</div>
                            </div>

                            <div class="agent-performance">
                                <div class="perf-item">
                                    <span class="perf-label">Completed</span>
                                    <span class="perf-value">${agent.tasksCompleted}</span>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-label">Tokens</span>
                                    <span class="perf-value">${agent.tokensUsed.toLocaleString()}</span>
                                </div>
                                <div class="perf-item">
                                    <span class="perf-label">Cost</span>
                                    <span class="perf-value">$${tokenCost}</span>
                                </div>
                            </div>

                            ${this.renderSimpleTaskQueue(agent)}
                            
                            <div class="bottom-info">
                                <span class="activity-info">Active ${this.formatTimeSince(timeSince)}</span>
                                <span class="token-info">${avgTokensPerTask} tokens/task</span>
                            </div>
                        </div>
                    `;
                });

                grid.innerHTML = html;
            }

            updateSummary() {
                const activeCount = this.agents.filter(a => a.status === 'active' || a.status === 'coordinating').length;
                const totalTokens = this.agents.reduce((sum, a) => sum + a.tokensUsed, 0);
                const totalCost = (totalTokens * 0.015 / 1000).toFixed(2);
                const totalTasks = this.agents.reduce((sum, a) => sum + a.tasksCompleted, 0);
                const sessionMinutes = Math.floor((Date.now() - this.startTime) / 60000);

                // Update values
                document.getElementById('activeAgents').textContent = activeCount;
                document.getElementById('totalTokens').textContent = totalTokens.toLocaleString();
                document.getElementById('totalCost').textContent = `$${totalCost}`;
                document.getElementById('totalTasks').textContent = totalTasks;
                document.getElementById('sessionTime').textContent = `${sessionMinutes}m`;

                // Highlight active agents if there are any
                const activeAgentsElement = document.getElementById('activeAgents');
                const activeAgentsItem = activeAgentsElement.closest('.summary-item');
                
                if (activeCount > 0) {
                    activeAgentsElement.classList.add('active-highlight');
                    activeAgentsItem.classList.add('active-highlight');
                } else {
                    activeAgentsElement.classList.remove('active-highlight');
                    activeAgentsItem.classList.remove('active-highlight');
                }
                
                // Also highlight total cost if significant
                const totalCostElement = document.getElementById('totalCost');
                const totalCostItem = totalCostElement.closest('.summary-item');
                
                if (parseFloat(totalCost) > 0.20) {  // Highlight if cost > $0.20
                    totalCostElement.classList.add('active-highlight');
                    totalCostItem.classList.add('active-highlight');
                }
            }

            updateActivity() {
                const feed = document.getElementById('activityFeed');
                if (!feed) return;

                // Generate activity items based on agent data
                let html = '<h3 style="margin-bottom: 20px;">âš¡ Recent Agent Activity</h3>';
                
                this.agents.forEach(agent => {
                    const timeSince = Math.floor((Date.now() / 1000) - agent.lastActivity);
                    if (timeSince < 300) { // Show activities from last 5 minutes
                        html += `
                            <div class="activity-item">
                                <div class="activity-icon">${this.getAgentIcon(agent.id)}</div>
                                <div class="activity-content">
                                    <div class="activity-title">${agent.name}</div>
                                    <div class="activity-description">${agent.currentTask}</div>
                                </div>
                                <div class="activity-time">${this.formatTimeSince(timeSince)}</div>
                            </div>
                        `;
                    }
                });

                feed.innerHTML = html;
            }

            initializeCharts() {
                // Agent Token Consumption Chart (Real-time)
                const agentTokenCtx = document.getElementById('agentTokenChart');
                if (agentTokenCtx) {
                    this.agentTokenChart = new Chart(agentTokenCtx, {
                        type: 'doughnut',
                        data: {
                            labels: [],
                            datasets: [{
                                data: [],
                                backgroundColor: [
                                    'oklch(0.81 0.10 252)',     // Bright blue - Active
                                    'oklch(0.62 0.19 260)',     // Green-blue - Coordinating
                                    'oklch(0.55 0.22 263)',     // Warm yellow - Ready
                                    'oklch(0.49 0.22 264)',     // Deep purple - Idle
                                    '#f59e0b',                  // Amber
                                    '#8b5cf6',                  // Violet
                                    '#06b6d4',                  // Cyan
                                    '#ef4444'                   // Red
                                ],
                                borderColor: '#374151',
                                borderWidth: 2,
                                hoverOffset: 15
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        color: '#ffffff',
                                        font: { size: 11 },
                                        padding: 12,
                                        usePointStyle: true,
                                        pointStyle: 'circle',
                                        boxWidth: 12
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            const tokens = context.raw;
                                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                            const percentage = ((tokens / total) * 100).toFixed(1);
                                            const cost = (tokens * 0.015 / 1000).toFixed(3);
                                            return [
                                                `${context.label}: ${tokens.toLocaleString()} tokens`,
                                                `${percentage}% of total consumption`,
                                                `Cost: $${cost}`
                                            ];
                                        }
                                    }
                                }
                            },
                            animation: {
                                animateRotate: true,
                                duration: 1000
                            }
                        }
                    });
                }

                // Performance Chart
                const perfCtx = document.getElementById('performanceChart');
                if (perfCtx) {
                    this.performanceChart = new Chart(perfCtx, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Agent Efficiency (%)',
                                data: [],
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderColor: '#10b981',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { color: '#ffffff' }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { color: '#ffffff' }
                                },
                                x: {
                                    ticks: { color: '#ffffff' }
                                }
                            }
                        }
                    });
                }
            }

            updateCharts() {
                // Update Agent Token Consumption Chart
                if (this.agentTokenChart && this.agents.length > 0) {
                    const agentData = this.agents
                        .filter(a => a.tokensUsed > 0)  // Only show agents with token usage
                        .sort((a, b) => b.tokensUsed - a.tokensUsed);  // Sort by highest token usage
                    
                    const totalTokens = agentData.reduce((sum, a) => sum + a.tokensUsed, 0);
                    
                    // Create labels with percentages
                    const labels = agentData.map(a => {
                        const percentage = ((a.tokensUsed / totalTokens) * 100).toFixed(1);
                        return `${a.name.replace(' Agent', '')} (${percentage}%)`;
                    });
                    const tokenData = agentData.map(a => a.tokensUsed);
                    
                    this.agentTokenChart.data.labels = labels;
                    this.agentTokenChart.data.datasets[0].data = tokenData;
                    this.agentTokenChart.update('active');
                }
                
                // Update Performance Chart  
                if (this.performanceChart && this.agents.length > 0) {
                    const labels = this.agents.map(a => a.name.replace(' Agent', ''));
                    const efficiencies = this.agents.map(a => a.efficiency);
                    
                    this.performanceChart.data.labels = labels;
                    this.performanceChart.data.datasets[0].data = efficiencies;
                    this.performanceChart.update('active');
                }
            }

            getAgentIcon(agentId) {
                const icons = {
                    'shadcn-optimization': 'ðŸ“ˆ',
                    'performance-audit': 'âš¡',
                    'accessibility': 'â™¿',
                    'code-quality': 'ðŸ”',
                    'ui-testing': 'ðŸ§ª',
                    'design-system': 'ðŸŽ¨',
                    'documentation': 'ðŸ“š',
                    'orchestrator': 'ðŸŽ¯'
                };
                return icons[agentId] || 'ðŸ¤–';
            }
            
            getStatusEmoji(status) {
                const emojis = {
                    'active': 'ðŸ”¥',
                    'coordinating': 'â­',
                    'ready': 'ðŸ’¡',
                    'idle': 'ðŸ’¤'
                };
                return emojis[status] || 'â“';
            }
            
            getStatusDescription(status) {
                const descriptions = {
                    'active': 'Working Hard',
                    'coordinating': 'Leading Tasks',
                    'ready': 'Standing By',
                    'idle': 'Resting'
                };
                return descriptions[status] || 'Unknown';
            }
            
            renderSimpleTaskQueue(agent) {
                if (!agent.taskQueue || agent.taskQueue.length === 0) {
                    return '<div class="task-summary"><span style="opacity: 0.6;">âœ… No pending tasks</span></div>';
                }
                
                const criticalTasks = agent.taskQueue.filter(t => t.priority === 'critical');
                const highTasks = agent.taskQueue.filter(t => t.priority === 'high');
                const topTask = criticalTasks[0] || highTasks[0] || agent.taskQueue[0];
                
                const queueCountClass = criticalTasks.length > 0 ? 'high-priority' : '';
                const priorityEmoji = topTask.priority === 'critical' ? 'ðŸ”´' : topTask.priority === 'high' ? 'ðŸŸ ' : 'ðŸ”µ';
                
                let taskListHtml = '';
                agent.taskQueue.forEach(task => {
                    taskListHtml += `
                        <div class="task-item priority-${task.priority}">
                            <div class="task-name">${task.task}</div>
                            <div class="task-meta">
                                <div class="task-time">${task.estimatedTime}</div>
                                <div class="task-priority ${task.priority}">${task.priority}</div>
                            </div>
                        </div>
                    `;
                });
                
                const cardId = agent.id.replace('-', '');
                
                return `
                    <div class="task-summary" onclick="this.nextElementSibling.classList.toggle('expanded')">
                        <div class="queue-summary">
                            <div class="queue-info">
                                <span>ðŸ“‹ ${agent.queueCount} tasks</span>
                                <div class="stat-separator"></div>
                                <span class="top-task">${priorityEmoji} ${topTask.task}</span>
                            </div>
                            <div class="queue-count ${queueCountClass}">${topTask.estimatedTime}</div>
                        </div>
                    </div>
                    <div class="task-queue" id="queue-${cardId}">
                        <div class="queue-header">
                            <div class="queue-title">ðŸ“‹ All Tasks</div>
                            <div class="queue-count ${queueCountClass}">${agent.queueCount}</div>
                        </div>
                        <div class="task-list">
                            ${taskListHtml}
                        </div>
                    </div>
                `;
            }

            formatTimeSince(seconds) {
                if (seconds < 60) return `${seconds}s ago`;
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                return `${Math.floor(seconds / 3600)}h ago`;
            }

            showError() {
                const grid = document.getElementById('agentsGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div style="text-align: center; padding: 40px; opacity: 0.6;">
                            <h3>âŒ Connection Error</h3>
                            <p>Unable to connect to Claude Code session</p>
                        </div>
                    `;
                }
            }

            initializeUsageBlocks() {
                this.loadTokenUsage();
            }

            async loadTokenUsage() {
                try {
                    const response = await fetch('/api/token-usage');
                    const data = await response.json();
                    
                    this.updateUsageBlocks(data);
                } catch (error) {
                    console.error('Error loading token usage:', error);
                }
            }

            updateUsageBlocks(data) {
                // Update token count header
                document.getElementById('usageTokenCount').textContent = 
                    `${(data.used/1000).toFixed(0)}k/${(data.total/1000).toFixed(0)}k tokens (${data.percentage}%)`;

                // Generate token blocks
                const blocksContainer = document.getElementById('usageBlocks');
                const totalBlocks = 400; // Total visual blocks to display
                const blocksPerCategory = {
                    'system-prompt': Math.floor((data.breakdown.system_prompt / data.used) * totalBlocks),
                    'system-tools': Math.floor((data.breakdown.system_tools / data.used) * totalBlocks),
                    'mcp-tools': Math.floor((data.breakdown.mcp_tools / data.used) * totalBlocks),
                    'memory-files': Math.floor((data.breakdown.memory_files / data.used) * totalBlocks),
                    'messages': Math.floor((data.breakdown.messages / data.used) * totalBlocks),
                    'agent-context': Math.floor((data.breakdown.agent_context / data.used) * totalBlocks)
                };

                // Calculate free space blocks
                const usedBlocks = Object.values(blocksPerCategory).reduce((sum, count) => sum + count, 0);
                const freeBlocks = totalBlocks - usedBlocks;

                let blocksHTML = '';

                // Add blocks for each category
                Object.entries(blocksPerCategory).forEach(([category, count]) => {
                    for (let i = 0; i < count; i++) {
                        blocksHTML += `<div class="token-block ${category}" title="${category.replace('-', ' ').toUpperCase()}: ${data.breakdown[category.replace('-', '_')]} tokens"></div>`;
                    }
                });

                // Add free space blocks
                for (let i = 0; i < freeBlocks; i++) {
                    blocksHTML += `<div class="token-block free-space" title="Free space"></div>`;
                }

                blocksContainer.innerHTML = blocksHTML;

                // Generate breakdown
                this.updateUsageBreakdown(data);
            }

            updateUsageBreakdown(data) {
                const breakdownContainer = document.getElementById('usageBreakdown');
                const categories = [
                    { key: 'system_prompt', label: 'System prompt', color: 'oklch(0.49 0.22 264)' },
                    { key: 'system_tools', label: 'System tools', color: 'oklch(0.55 0.22 263)' },
                    { key: 'mcp_tools', label: 'MCP tools', color: 'oklch(0.62 0.19 260)' },
                    { key: 'memory_files', label: 'Memory files', color: 'oklch(0.72 0.15 257)' },
                    { key: 'messages', label: 'Messages', color: 'oklch(0.81 0.10 252)' },
                    { key: 'agent_context', label: 'ðŸ¤– Agent Context', color: 'linear-gradient(45deg, oklch(0.65 0.18 340), oklch(0.75 0.15 320))' }
                ];

                let breakdownHTML = '';
                categories.forEach(cat => {
                    const tokens = data.breakdown[cat.key];
                    const percentage = ((tokens / data.used) * 100).toFixed(1);
                    const cost = (tokens * 0.015 / 1000).toFixed(3);

                    breakdownHTML += `
                        <div class="breakdown-item">
                            <div class="breakdown-icon" style="background: ${cat.color};"></div>
                            <div class="breakdown-text">
                                <div class="breakdown-label">${cat.label}</div>
                                <div class="breakdown-value">${tokens.toLocaleString()} tokens (${percentage}%) â€¢ $${cost}</div>
                            </div>
                        </div>
                    `;
                });

                breakdownContainer.innerHTML = breakdownHTML;
                
                // Generate agent context grid
                this.updateAgentContextGrid(data);
            }

            updateAgentContextGrid(data) {
                if (!data.agent_context) return;
                
                const contextGrid = document.getElementById('agentContextGrid');
                const agentNames = {
                    'shadcn_optimization': 'ðŸ“ˆ ShadCN Optimization',
                    'performance_audit': 'âš¡ Performance Audit',
                    'code_quality': 'ðŸ” Code Quality',
                    'orchestrator': 'ðŸŽ¯ Master Orchestrator',
                    'design_system': 'ðŸŽ¨ Design System',
                    'documentation': 'ðŸ“š Documentation',
                    'accessibility': 'â™¿ Accessibility',
                    'ui_testing': 'ðŸ§ª UI Testing'
                };

                let contextHTML = '';
                
                // Sort agents by context usage
                const sortedAgents = Object.entries(data.agent_context)
                    .sort(([,a], [,b]) => b - a);

                sortedAgents.forEach(([agentKey, contextTokens]) => {
                    const name = agentNames[agentKey] || agentKey;
                    const cost = (contextTokens * 0.015 / 1000).toFixed(3);
                    const percentage = ((contextTokens / data.agent_context_total) * 100).toFixed(1);

                    contextHTML += `
                        <div class="agent-context-item">
                            <div class="agent-context-name">${name}</div>
                            <div class="agent-context-usage">
                                <span class="agent-context-tokens">${contextTokens.toLocaleString()} tokens (${percentage}%)</span>
                                <span class="agent-context-cost">$${cost}</span>
                            </div>
                        </div>
                    `;
                });

                contextGrid.innerHTML = contextHTML;
            }

            async loadUsageHistory(hours = 24) {
                try {
                    const response = await fetch(`/api/usage-history?hours=${hours}`);
                    const data = await response.json();
                    
                    this.updateHistoryCharts(data.history);
                    this.updateHistoryStats(data);
                    
                    // Hide loading indicator
                    const loading = document.getElementById('historyLoading');
                    if (loading) loading.style.display = 'none';
                    
                } catch (error) {
                    console.error('Failed to load usage history:', error);
                }
            }

            updateHistoryCharts(history) {
                if (history.length === 0) return;

                // Prepare data for charts
                const times = history.reverse().map(h => new Date(h.timestamp).toLocaleTimeString());
                const tokenData = history.map(h => h.used_tokens);
                const costData = history.map(h => h.cost);

                // Update token usage chart
                const tokenCtx = document.getElementById('historyTokenChart');
                if (tokenCtx) {
                    if (this.historyTokenChart) {
                        this.historyTokenChart.destroy();
                    }
                    
                    this.historyTokenChart = new Chart(tokenCtx, {
                        type: 'line',
                        data: {
                            labels: times,
                            datasets: [{
                                label: 'Token Usage',
                                data: tokenData,
                                borderColor: 'oklch(0.81 0.10 252)',
                                backgroundColor: 'oklch(0.81 0.10 252 / 0.2)',
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                }
                            }
                        }
                    });
                }

                // Update cost chart
                const costCtx = document.getElementById('historyCostChart');
                if (costCtx) {
                    if (this.historyCostChart) {
                        this.historyCostChart.destroy();
                    }
                    
                    this.historyCostChart = new Chart(costCtx, {
                        type: 'bar',
                        data: {
                            labels: times,
                            datasets: [{
                                label: 'Cost',
                                data: costData,
                                backgroundColor: 'oklch(0.62 0.19 260 / 0.8)',
                                borderColor: 'oklch(0.62 0.19 260)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { 
                                        color: 'rgba(255, 255, 255, 0.7)',
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: 'rgba(255, 255, 255, 0.7)' }
                                }
                            }
                        }
                    });
                }
            }

            updateHistoryStats(data) {
                const history = data.history;
                if (history.length === 0) return;

                // Calculate statistics
                const totalRecords = data.total_records;
                const avgTokens = Math.round(history.reduce((sum, h) => sum + h.used_tokens, 0) / history.length);
                const totalCost = history.reduce((sum, h) => sum + h.cost, 0);
                const peakUsage = Math.max(...history.map(h => h.used_tokens));

                // Update stat displays
                document.getElementById('totalSessions').textContent = totalRecords.toLocaleString();
                document.getElementById('avgTokensPerSession').textContent = avgTokens.toLocaleString();
                document.getElementById('totalCostHistory').textContent = '$' + totalCost.toFixed(2);
                document.getElementById('peakUsage').textContent = peakUsage.toLocaleString();
            }

            initializeHistoryTab() {
                // Add event listeners for time control buttons
                document.querySelectorAll('.time-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active class from all buttons
                        document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        btn.classList.add('active');
                        
                        // Load data for selected time range
                        const hours = parseInt(btn.getAttribute('data-hours'));
                        this.loadUsageHistory(hours);
                    });
                });

                // Load default data (24 hours)
                this.loadUsageHistory(24);
            }

            startMonitoring() {
                // Initialize history tab
                this.initializeHistoryTab();
                
                // Refresh every 3 seconds
                setInterval(() => {
                    this.loadData();
                    this.loadTokenUsage(); // Also refresh token usage
                    
                    // Refresh history if on history tab
                    const activeTab = document.querySelector('.tab-content.active');
                    if (activeTab && activeTab.id === 'history') {
                        const activeTimeBtn = document.querySelector('.time-btn.active');
                        const hours = activeTimeBtn ? parseInt(activeTimeBtn.getAttribute('data-hours')) : 24;
                        this.loadUsageHistory(hours);
                    }
                }, 3000);
            }
        }

        // Start monitoring when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new UnifiedClaudeMonitor();
        });
    </script>
</body>
</html>